{% extends "base.html" %}

{% block title %}Audit - Ki·ªÉm to√°n{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üìù Audit - Ki·ªÉm to√°n</h1>
    <a href="/security" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<div class="info-card">
    <h3>C∆° ch·∫ø ho·∫°t ƒë·ªông</h3>
    <p>Oracle Audit ghi l·∫°i m·ªçi h√†nh ƒë·ªông quan tr·ªçng:</p>
    <ul>
        <li><strong>FGA (Fine-Grained Auditing):</strong> Gi√°m s√°t chi ti·∫øt c·ªôt BUDGET</li>
        <li><strong>Unified Audit:</strong> Login/Logout, DDL, DML quan tr·ªçng</li>
    </ul>
</div>

<!-- Audit Policies -->
<div class="demo-section">
    <h3>üìã Audit Policies ƒëang Active</h3>
    {% if audit_policies %}
    <table class="table">
        <thead>
            <tr>
                <th>Policy Name</th>
                <th>Enabled Option</th>
                <th>Entity</th>
            </tr>
        </thead>
        <tbody>
            {% for policy in audit_policies %}
            <tr>
                <td><strong>{{ policy.policy_name }}</strong></td>
                <td><span class="badge badge-success">{{ policy.enabled_option }}</span></td>
                <td>{{ policy.entity_name }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-warning">Ch∆∞a c√≥ Unified Audit policies. Ch·∫°y script <code>05_create_audit.sql</code></div>
    {% endif %}
</div>

<!-- FGA Logs -->
<div class="demo-section">
    <h3>üîç FGA Audit Trail (Gi√°m s√°t BUDGET)</h3>
    <p class="text-muted">Log c√°c l·∫ßn truy c·∫≠p/c·∫≠p nh·∫≠t c·ªôt BUDGET</p>

    {% if fga_logs %}
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Object</th>
                <th>Policy</th>
                <th>Statement</th>
                <th>SQL</th>
            </tr>
        </thead>
        <tbody>
            {% for log in fga_logs %}
            <tr>
                <td><small>{{ log.timestamp }}</small></td>
                <td><span class="badge badge-info">{{ log.db_user }}</span></td>
                <td>{{ log.object_schema }}.{{ log.object_name }}</td>
                <td>{{ log.policy_name }}</td>
                <td>{{ log.statement_type }}</td>
                <td><code class="sql-text">{{ log.sql_text[:50] }}{% if log.sql_text|length > 50 %}...{% endif %}</code>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info">Ch∆∞a c√≥ FGA logs. Th·ª≠ UPDATE m·ªôt project ƒë·ªÉ t·∫°o log.</div>
    {% endif %}
</div>

<!-- Unified Audit Logs -->
<div class="demo-section">
    <h3>üìä Unified Audit Trail</h3>
    <p class="text-muted">Log login/logout v√† c√°c h√†nh ƒë·ªông tr√™n PROJECTS</p>

    {% if unified_logs %}
    <table class="table table-sm">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>User</th>
                <th>Action</th>
                <th>Object</th>
                <th>Return Code</th>
            </tr>
        </thead>
        <tbody>
            {% for log in unified_logs %}
            <tr>
                <td><small>{{ log.event_timestamp }}</small></td>
                <td><span class="badge badge-info">{{ log.dbusername }}</span></td>
                <td>
                    {% if log.action_name == 'LOGON' %}
                    <span class="badge badge-success">{{ log.action_name }}</span>
                    {% elif log.action_name == 'LOGOFF' %}
                    <span class="badge badge-secondary">{{ log.action_name }}</span>
                    {% else %}
                    <span class="badge badge-warning">{{ log.action_name }}</span>
                    {% endif %}
                </td>
                <td>{{ log.object_schema }}.{{ log.object_name if log.object_name else '-' }}</td>
                <td>
                    {% if log.return_code == 0 %}
                    <span class="text-success">Success</span>
                    {% else %}
                    <span class="text-danger">{{ log.return_code }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info">Ch∆∞a c√≥ Unified Audit logs.</div>
    {% endif %}
</div>

<div class="test-box">
    <h3>üß™ C√°ch ki·ªÉm tra Audit</h3>
    <ol>
        <li>V√†o <a href="/projects">Projects</a> v√† s·ª≠a BUDGET c·ªßa m·ªôt project</li>
        <li>Refresh trang n√†y ‚Üí Th·∫•y log trong FGA Audit Trail</li>
        <li>Login/Logout ‚Üí Th·∫•y log trong Unified Audit Trail</li>
    </ol>
</div>

<style>
    .info-card {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .demo-section {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .test-box {
        background: var(--bg-secondary);
        border-left: 4px solid #f5576c;
        padding: 1.5rem;
        border-radius: 0 8px 8px 0;
    }

    .sql-text {
        font-size: 0.75rem;
        max-width: 200px;
        display: inline-block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
{% endblock %}