{% extends "base.html" %}

{% block title %}Data Redaction{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üé≠ Data Redaction</h1>
    <a href="/security" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<div class="intro-box">
    <h3>B·∫£o v·ªá d·ªØ li·ªáu nh·∫°y c·∫£m (PII)</h3>
    <p>Oracle Data Redaction cho ph√©p che gi·∫•u d·ªØ li·ªáu (masking) khi tr·∫£ v·ªÅ cho user m√† kh√¥ng c·∫ßn thay ƒë·ªïi d·ªØ li·ªáu g·ªëc
        trong database.</p>
    <ul>
        <li><strong>Full Redaction:</strong> Che to√†n b·ªô c·ªôt (tr·∫£ v·ªÅ NULL ho·∫∑c gi√° tr·ªã tƒ©nh).</li>
        <li><strong>Partial Redaction:</strong> Che m·ªôt ph·∫ßn (VD: s·ªë th·∫ª t√≠n d·ª•ng, s·ªë ƒëi·ªán tho·∫°i).</li>
        <li><strong>Regexp Redaction:</strong> Che theo m·∫´u Regex (VD: Email).</li>
        <li><strong>Random Redaction:</strong> Tr·∫£ v·ªÅ gi√° tr·ªã ng·∫´u nhi√™n.</li>
    </ul>
    <p><strong>∆Øu ƒëi·ªÉm:</strong> ·ª®ng d·ª•ng kh√¥ng c·∫ßn thay ƒë·ªïi code query. Policy ƒë∆∞·ª£c √°p d·ª•ng t·ª± ƒë·ªông t·∫°i Database Layer.
    </p>
</div>

<!-- Active Policies -->
<div class="section-container">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">üõ°Ô∏è Active Policies</h5>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if policies %}
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Policy Name</th>
                            <th>Object</th>
                            <th>Expression</th>
                            <th>Enabled</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in policies %}
                        <tr>
                            <td><strong>{{ p.policy_name }}</strong></td>
                            <td>{{ p.object_name }}</td>
                            <td><code>{{ p.expression }}</code></td>
                            <td>
                                {% if p.enable == 'YES' %}
                                <span class="badge badge-success">YES</span>
                                {% else %}
                                <span class="badge badge-secondary">NO</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning" style="margin: 1rem;">Ch∆∞a c√≥ Policy n√†o ƒë∆∞·ª£c c·∫•u h√¨nh.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Redaction Rules -->
<div class="section-container" style="margin-top: 1.5rem;">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">üìã C·∫•u h√¨nh Redaction (Column Rules)</h5>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if columns %}
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Column</th>
                            <th>Type</th>
                            <th>Parameters / Pattern</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for col in columns %}
                        <tr>
                            <td><code>{{ col.column_name }}</code></td>
                            <td><span class="badge badge-info">{{ col.function_type }}</span></td>
                            <td>
                                {% if col.function_type == 'regexp' %}
                                <strong>Pattern:</strong> <code>{{ col.regexp_pattern }}</code><br>
                                <strong>Replace:</strong> <code>{{ col.regexp_replace_string }}</code>
                                {% else %}
                                <code>{{ col.function_parameters }}</code>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info" style="margin: 1rem;">Kh√¥ng c√≥ c·ªôt n√†o b·ªã redactor.</div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Live Demo -->
<div class="section-container" style="margin-top: 1.5rem;">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title">üëÄ Live Demo: User View (APP_ADMIN)</h5>
            <span class="badge badge-success" style="margin-left: auto;">K·∫øt n·ªëi th·ª±c t·∫ø</span>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if demo_error %}
            <div class="alert alert-error" style="margin: 1rem;">{{ demo_error }}</div>
            {% endif %}

            {% if demo_data %}
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email (Redacted)</th>
                            <th>Phone (Redacted)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in demo_data %}
                        <tr>
                            <td>{{ row.username }}</td>
                            <td>{{ row.full_name }}</td>
                            <td class="text-danger font-weight-bold">{{ row.email }}</td>
                            <td class="text-danger font-weight-bold">{{ row.phone }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div style="padding: 1rem; border-top: 1px solid var(--border);">
                <small class="text-muted">
                    * D·ªØ li·ªáu hi·ªÉn th·ªã ·ªü tr√™n l√† k·∫øt qu·∫£ tr·∫£ v·ªÅ tr·ª±c ti·∫øp t·ª´ Database khi k·∫øt n·ªëi b·∫±ng user th∆∞·ªùng.
                    Backend kh√¥ng can thi·ªáp x·ª≠ l√Ω chu·ªói.
                </small>
            </div>
            {% else %}
            <div class="alert alert-info" style="margin: 1rem;">Kh√¥ng c√≥ d·ªØ li·ªáu demo.</div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .intro-box {
        background: linear-gradient(135deg, #FF6B6B 0%, #d63031 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .intro-box ul {
        margin-top: 0.5rem;
        padding-left: 1.5rem;
    }

    .badge-info {
        background-color: #0984e3;
        color: white;
    }
</style>
{% endblock %}