{% extends "base.html" %}

{% block title %}Database Vault{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üè∞ Database Vault</h1>
    <a href="/security" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

<div class="info-card">
    <h3>Database Vault - Thay th·∫ø OLS</h3>
    <p>Database Vault b·∫£o v·ªá d·ªØ li·ªáu nh·∫°y c·∫£m b·∫±ng c√°ch:</p>
    <ul>
        <li><strong>Realms:</strong> T·∫°o v√πng b·∫£o v·ªá cho tables - ngay c·∫£ DBA c≈©ng kh√¥ng access ƒë∆∞·ª£c</li>
        <li><strong>Command Rules:</strong> Ki·ªÉm so√°t SQL commands (UPDATE, DELETE, etc.)</li>
        <li><strong>Separation of Duties:</strong> Ph√¢n t√°ch quy·ªÅn qu·∫£n tr·ªã</li>
    </ul>
</div>

<!-- DV Status -->
<div class="demo-section">
    <h3>üìä Database Vault Status</h3>
    {% if dv_status %}
    <table class="table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for status in dv_status %}
            <tr>
                <td>{{ status.name if status.name else 'Database Vault' }}</td>
                <td>
                    {% if status.status == 'TRUE' or status.status == 'ENABLED' %}
                    <span class="badge badge-success">ENABLED</span>
                    {% else %}
                    <span class="badge badge-warning">{{ status.status }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-warning">
        Database Vault ch∆∞a ƒë∆∞·ª£c enable ho·∫∑c kh√¥ng c√≥ quy·ªÅn truy c·∫≠p.
        <br>Ch·∫°y script <code>07_create_dbvault.sql</code>
    </div>
    {% endif %}
</div>

<!-- Realms -->
<div class="demo-section">
    <h3>üõ°Ô∏è Realms (V√πng b·∫£o v·ªá)</h3>
    {% if realms %}
    <table class="table">
        <thead>
            <tr>
                <th>Realm Name</th>
                <th>Description</th>
                <th>Enabled</th>
                <th>Audit</th>
            </tr>
        </thead>
        <tbody>
            {% for realm in realms %}
            <tr>
                <td><strong>{{ realm.realm_name }}</strong></td>
                <td>{{ realm.description }}</td>
                <td>
                    {% if realm.enabled == 'Y' or realm.enabled == 'YES' %}
                    <span class="badge badge-success">YES</span>
                    {% else %}
                    <span class="badge badge-secondary">NO</span>
                    {% endif %}
                </td>
                <td>{{ realm.audit_options }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info">Ch∆∞a c√≥ Realms ƒë∆∞·ª£c t·∫°o.</div>
    {% endif %}
</div>

<!-- Realm Objects -->
<div class="demo-section">
    <h3>üì¶ Objects trong Realm</h3>
    {% if realm_objects %}
    <table class="table">
        <thead>
            <tr>
                <th>Realm</th>
                <th>Owner</th>
                <th>Object Name</th>
                <th>Type</th>
            </tr>
        </thead>
        <tbody>
            {% for obj in realm_objects %}
            <tr>
                <td>{{ obj.realm_name }}</td>
                <td>{{ obj.owner }}</td>
                <td><code>{{ obj.object_name }}</code></td>
                <td><span class="badge badge-info">{{ obj.object_type }}</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info">Ch∆∞a c√≥ objects trong realm.</div>
    {% endif %}
</div>

<!-- Command Rules -->
<div class="demo-section">
    <h3>‚öôÔ∏è Command Rules</h3>
    <p class="text-muted">Quy t·∫Øc ki·ªÉm so√°t c√°c l·ªánh SQL</p>
    {% if command_rules %}
    <table class="table">
        <thead>
            <tr>
                <th>Command</th>
                <th>Rule Set</th>
                <th>Object</th>
                <th>Enabled</th>
            </tr>
        </thead>
        <tbody>
            {% for rule in command_rules %}
            <tr>
                <td><span class="badge badge-warning">{{ rule.command }}</span></td>
                <td>{{ rule.rule_set_name }}</td>
                <td>{{ rule.object_owner }}.{{ rule.object_name }}</td>
                <td>
                    {% if rule.enabled == 'Y' or rule.enabled == 'YES' %}
                    <span class="badge badge-success">YES</span>
                    {% else %}
                    <span class="badge badge-secondary">NO</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info">Ch∆∞a c√≥ Command Rules.</div>
    {% endif %}
</div>

<div class="test-box">
    <h3>üß™ C√°ch ki·ªÉm tra Database Vault</h3>
    <ol>
        <li>Login v·ªõi user KH√îNG c√≥ trong realm authorization</li>
        <li>Th·ª≠ <code>SELECT * FROM PROJECTS</code> ‚Üí B·ªã ch·∫∑n</li>
        <li>Login v·ªõi ADMIN ‚Üí Access b√¨nh th∆∞·ªùng</li>
        <li>Th·ª≠ <code>UPDATE PROJECTS SET BUDGET = 999</code> v·ªõi user kh√¥ng c√≥ FINANCE_ROLE ‚Üí B·ªã ch·∫∑n</li>
    </ol>
</div>

<style>
    .info-card {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .demo-section {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .test-box {
        background: var(--bg-secondary);
        border-left: 4px solid #4facfe;
        padding: 1.5rem;
        border-radius: 0 8px 8px 0;
    }
</style>
{% endblock %}