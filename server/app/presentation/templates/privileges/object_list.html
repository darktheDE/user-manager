{% extends "base.html" %}

{% block title %}Quyền Đối tượng - User Manager{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Quyền trên Đối tượng (Object Privileges)</h1>
    <div class="header-actions">
        <a href="/privileges" class="btn btn-secondary">
            <i class="icon-key"></i> Quản lý Quyền Hệ thống
        </a>
        <a href="/privileges/object/grant" class="btn btn-primary">
            <i class="icon-plus"></i> Cấp Quyền Đối tượng
        </a>
        <a href="/privileges/column/grant" class="btn btn-secondary">
            <i class="icon-columns"></i> Cấp Quyền trên Cột
        </a>
    </div>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if success %}
<div class="alert alert-success">{{ success }}</div>
{% endif %}

<div class="card">
    <div class="card-header">
        <h3>Lọc theo User/Role</h3>
    </div>
    <div class="card-body">
        <form method="GET" action="/privileges/object" class="form-inline">
            <div class="form-group">
                <label for="grantee">Chọn User/Role:</label>
                <select name="grantee" id="grantee" class="form-control" onchange="this.form.submit()">
                    <option value="">-- Chọn --</option>
                    <optgroup label="Users">
                        {% for user in users %}
                        <option value="{{ user.username }}" {% if selected_grantee==user.username %}selected{% endif %}>
                            {{ user.username }}
                        </option>
                        {% endfor %}
                    </optgroup>
                    <optgroup label="Roles">
                        {% for role in roles %}
                        <option value="{{ role.role }}" {% if selected_grantee==role.role %}selected{% endif %}>
                            {{ role.role }}
                        </option>
                        {% endfor %}
                    </optgroup>
                </select>
            </div>
        </form>
    </div>
</div>

{% if selected_grantee %}
<div class="card mt-4">
    <div class="card-header">
        <h3>Quyền Đối tượng của: {{ selected_grantee }}</h3>
    </div>
    <div class="card-body">
        {% if object_privs %}
        <table class="table">
            <thead>
                <tr>
                    <th>Chủ sở hữu</th>
                    <th>Tên Bảng</th>
                    <th>Quyền</th>
                    <th>Grantable</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                {% for priv in object_privs %}
                <tr>
                    <td>{{ priv.owner }}</td>
                    <td>{{ priv.table_name }}</td>
                    <td><span class="badge badge-info">{{ priv.privilege }}</span></td>
                    <td>
                        {% if priv.grantable == 'YES' %}
                        <span class="badge badge-success">CÓ</span>
                        {% else %}
                        <span class="badge badge-secondary">KHÔNG</span>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" action="/privileges/object/revoke" style="display:inline;">
                            <input type="hidden" name="grantee" value="{{ selected_grantee }}">
                            <input type="hidden" name="privilege" value="{{ priv.privilege }}">
                            <input type="hidden" name="table_owner" value="{{ priv.owner }}">
                            <input type="hidden" name="table_name" value="{{ priv.table_name }}">
                            <button type="submit" class="btn btn-sm btn-danger"
                                onclick="return confirm('Thu hồi quyền {{ priv.privilege }} trên bảng {{ priv.owner }}.{{ priv.table_name }}?')">
                                Thu hồi
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">Không tìm thấy quyền đối tượng nào cho User/Role này.</p>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="info-box mt-4">
    <h4>Thông tin Quyền Đối tượng (Bảng)</h4>
    <ul>
        <li><strong>SELECT:</strong> Xem dữ liệu từ bảng</li>
        <li><strong>INSERT:</strong> Thêm dòng mới vào bảng</li>
        <li><strong>UPDATE:</strong> Cập nhật dữ liệu hiện có</li>
        <li><strong>DELETE:</strong> Xóa dữ liệu khỏi bảng</li>
    </ul>
    <p><strong>Cấp độ Cột:</strong> SELECT và INSERT có thể được cấp riêng cho từng cột cụ thể.</p>
</div>
{% endblock %}